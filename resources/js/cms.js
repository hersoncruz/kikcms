function Class(){}function capitalize(t){return t.charAt(0).toUpperCase()+t.slice(1)}Class.prototype.construct=function(){},Class.__asMethod__=function(t,e){return function(){var i=this.$;this.$=e;var n=t.apply(this,arguments);return this.$=i,n}},Class.extend=function(t){var e=function(){arguments[0]!==Class&&this.construct.apply(this,arguments)},i=new this(Class),n=this.prototype;for(var a in t){var s=t[a];s instanceof Function&&(s=Class.__asMethod__(s,n)),i[a]=s}return i.$=n,e.prototype=i,e.extend=this.extend,e},$.fn.highlight=function(t){function e(t,i){var n=0;if(3==t.nodeType){var a=t.data.toUpperCase().indexOf(i);if((a-=t.data.substr(0,a).toUpperCase().length-t.data.substr(0,a).length)>=0){var s=document.createElement("span");s.className="highlight";var o=t.splitText(a);o.splitText(i.length);var r=o.cloneNode(!0);s.appendChild(r),o.parentNode.replaceChild(s,o),n=1}}else if(1==t.nodeType&&t.childNodes&&!/(script|style)/i.test(t.tagName))for(var l=0;l<t.childNodes.length;++l)l+=e(t.childNodes[l],i);return n}return this.length&&t&&t.length?this.each(function(){e(this,t.toUpperCase())}):this},$.fn.searchAble=function(t){var e="",i="",n=this,a=n.next(".glyphicon-remove");a.click(function(){n.val(""),n.trigger("keyup")}),n.on("keyup",function(s){var o=n.val();if(""==o?a.hide():a.show(),s.keyCode==keyCode.ENTER)return i=o,void t(o);e=o,setTimeout(function(){o==e&&o!=i&&(i=o,t(o))},500)})},$.fn.serializeObject=function(){var t={},e=this.serializeArray();return $.each(e,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t};var keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,SHIFT:16,S:83},KikCmsClass=Class.extend({baseUri:null,translations:{},errorMessages:{},isDev:!1,maxFileUploads:null,maxFileSize:null,maxFileSizeString:null,renderables:{},initRenderables:function(t){var e=this;t=void 0!==t?t:null,$("[data-renderable]").each(function(){var i=$(this);if("true"!=i.attr("data-rendered")){var n=$.parseJSON(i.attr("data-renderable")),a=n.properties.renderableInstance;e.renderables[a]=new window[n.class],$.each(n.properties,function(t,i){e.renderables[a][t]=i}),t&&(e.renderables[a].parent=t),e.renderables[a].init(),i.attr("data-rendered",!0)}})},action:function(t,e,i,n,a,s){var o=!1,r=this,l=0;s=void 0!==s?s:null,setTimeout(function(){0==o&&KikCMS.showLoader()},250);var d=$("html").attr("lang");d&&(e.activeLangCode=d);var c={url:t,type:"post",dataType:"json",data:e,success:function(t,e,n){o=!0,r.hideLoader(),i(t,e,n),r.initRenderables(s)},error:function(t){if(0==t.readyState&&0==t.status&&l<2)return l++,void h();o=!0,r.showError(t,n)}};void 0!==a&&a&&(c.cache=!1,c.contentType=!1,c.processData=!1,c.xhr=a);var h=function(){$.ajax(c)};h()},showError:function(t,e){void 0!==e&&e(),this.hideLoader();var i=this.translations["error."+t.status+".title"]?t.status:"unknown";this.isDev&&440!=t.status?$("#ajaxDebugger").html(t.responseText).show():alert(this.translations["error."+i+".title"]+"\n\n"+this.translations["error."+i+".description"])},showLoader:function(){this.getLoader().addClass("show")},hideLoader:function(){this.getLoader().removeClass("show")},getLoader:function(){return $("#cmsLoader")},removeExtension:function(t){return t.replace(/\.[^\/.]+$/,"")},tl:function(t,e){var i=this.translations[t];return $.each(e,function(t,e){i=i.replace(new RegExp(":"+t,"g"),e)}),i},toSlug:function(t){t=t.replace(/^\s+|\s+$/g,"").toLowerCase();for(var e="àáäâèéëêìíïîòóöôùúüûñç·/_,:;",i="aaaaeeeeiiiioooouuuunc------",n=0,a=e.length;n<a;n++)t=t.replace(new RegExp(e.charAt(n),"g"),i.charAt(n));return t=t.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-")}}),KikCMS=new KikCmsClass;$(function(){KikCMS.initRenderables()});var DataTable=Class.extend({actionPath:"/cms/datatable/",renderableInstance:null,renderableClass:null,labels:null,currentSearch:null,currentFormInput:null,parentEditId:null,$table:null,getDeleteConfirmMessage:function(t){var e=capitalize(KikCMS.tl("dataTable.delete.confirmOne",{itemSingular:this.labels[0]}));return t>1&&(e=KikCMS.tl("dataTable.delete.confirm",{amount:t,itemPlural:this.labels[1]})),e},getFormGroups:function(){return this.getWindow().find("form :input").not(".datatable :input")},getFormSerialized:function(){return this.getFormGroups().serialize()},getThumbHoverContainer:function(){return 0===$("body > .datatableThumbHoverContainer").length&&$("body").append('<div class="datatableThumbHoverContainer"></div>'),$("body > .datatableThumbHoverContainer")},init:function(){this.initTable(),this.initPagination(),this.initSearch(),this.initLanguageSwitch(),this.initButtons(),this.initKeyEvents(),this.initFilters()},initButtons:function(){var t=this,e=this.getDataTable().find(".toolbar .btn.delete"),i=this.getDataTable().find(".toolbar .btn.add");e.click(function(){var e=t.getSelectedIds();if(e){var i=e.length,n=t.getDeleteConfirmMessage(i);confirm(n)&&t.actionDelete(e)}}),i.click(function(){t.actionAdd()})},initFilters:function(){var t=this;this.getFilterForm().find("input, select").change(function(){t.actionPage(1)})},initImageThumbs:function(){var t=this,e=this.getDataTable().find("table tr td .thumb"),i=function(e){var i=$(window).scrollTop(),n=$(window).scrollLeft(),a=e.clientX+n+15,s=e.clientY+i+15;t.getThumbHoverContainer().css({left:a,top:s})};e.each(function(){var e=$(this),n=e.parent();n.hover(function(n){var a=t.getThumbHoverContainer();i(n),a.show(),a.html('<img src="'+e.attr("data-thumb-url")+'" />')},function(){t.getThumbHoverContainer().hide()}),n.mousemove(i)}),e.click(function(t){window.open($(this).attr("data-url")),t.stopPropagation()})},initKeyEvents:function(){var t=this,e={},i=function(e){if((e.metaKey||e.ctrlKey)&&e.keyCode==keyCode.S){if(t.getWindow().hasClass("blur")||!t.getForm().length)return!0;t.actionSave(!0),t.getWindow().find(".saveAndClose").addClass("active"),e.preventDefault()}},n=function(e){if(e.keyCode==keyCode.ESCAPE){if(t.getWindow().hasClass("blur")||!t.getForm().length)return!0;t.attemptToCloseWindow()}},a=function(){var t=$(this).attr("id");if(!e[t]){e[t]=t;$(this.contentWindow.document).keydown(i)}},s=function(){$("body").find("iframe").each(a),setTimeout(s,1e3)};s(),$(window).unbind("keydown."+this.renderableInstance),$(window).unbind("keypress."+this.renderableInstance),$(window).bind("keydown."+this.renderableInstance,i),$(window).bind("keypress."+this.renderableInstance,n)},initLanguageSwitch:function(){var t=this;this.getDataTable().find(".language select").change(function(){t.actionPage(t.getFilters().page)})},initPagination:function(){var t=this;this.getDataTable().find(".pagination a").click(function(){var e=$(this);if(e.parent().hasClass("active")||e.parent().hasClass("disabled"))return!1;var i=e.attr("data-page");t.actionPage(i)})},initSearch:function(){var t=this;this.getSearchField().searchAble(function(e){var i=t.getFilters();i.search=e,i.page=1,t.action("search",i,function(e){t.setTableContent(e.table),t.setPagesContent(e.pagination)})})},initSort:function(){var t=this,e=new SortControl;e.$dataTable=this.getDataTable(),e.onDrop=function(e,i,n){t.action("rearrange",{id:e,targetId:i,position:n},function(e){t.setTableContent(e.table)})},e.init()},initTable:function(){this.$table=this.getDataTable().find("table");var t=this,e=this.$table.find("tbody tr");e.find("td a").click(function(t){t.stopPropagation()}),e.find("td:not(.action)").click(function(){var e=$(this).parent();e.attr("data-prevent-click")||t.onRowClick(e)}),e.find("td.edit").click(function(){var e=$(this).find("input[name=id]").val();t.actionEdit(e)}),e.find("td:not(.action)").on("dblclick",function(){t.onRowDblClick($(this).parent())});var i=this.getSearchField().val();i&&t.getDataTable().find(".table").find("td").highlight(i),this.getDataTable().find("thead td").click(function(){var e=$(this),i=e.attr("data-column"),n=e.attr("data-sort"),a="asc";"asc"==n?a="desc":"desc"==n&&(a=""),a||(i=""),t.actionSort(i,a)}),this.initImageThumbs(),this.updateToolbar(),this.initTableCheckBoxes(),void 0!==SortControl&&this.initSort()},initTableCheckBoxes:function(){var t=this;this.$table.find("input.table-checkbox[type=checkbox]").click(function(t){t.stopPropagation()}).dblclick(function(t){t.stopPropagation()}).change(function(){var e=$(this),i=e.is(":checked"),n=e.parent().parent().attr("data-id"),a=e.attr("data-col");e.attr("readonly","readonly"),t.action("checkCheckbox",{editId:n,column:a,checked:i?1:0},function(){e.removeAttr("readonly")},function(){e.removeAttr("readonly")})})},initTabs:function(){var t=this.getWindow(),e=t.find(".tab-contents");t.find(".tabs .tab").each(function(){var t=$(this),i=t.attr("data-tab"),n=e.find(".tab-"+i);t.click(function(){t.siblings().removeClass("active"),t.addClass("active"),e.find(".tab-content").removeClass("active"),n.addClass("active")}),n.find(".has-error").length>0&&t.addClass("error")})},initWindow:function(){var t=this,e=this.getWindow(),i=e.find(".header select[name=language]");this.initWindowSize(),this.initTabs(),e.find(".saveAndClose").click(function(){t.actionSave(!0)}),e.find(".save").click(function(){t.actionSave(!1)}),this.onChange(i,function(){t.actionReloadWindow()}),this.currentFormInput=this.getFormSerialized(),$(window).resize(this.initWindowSize.bind(this))},initWindowSize:function(){var t=this.getWindow(),e=t.height(),i=t.find(".windowContent > .header").outerHeight(),n=t.find(".windowContent > .footer").outerHeight(),a=0;t.find(".windowContent > .tabs").length>0&&(a=t.find(".windowContent > .tabs").outerHeight()),t.find(".content").css("height",e-i-n-a)},action:function(t,e,i,n){e=this.addActionParameters(e),KikCMS.action(this.actionPath+t,e,i,n,null,this)},actionAdd:function(t){var e=this,i=this.getFilters();if(void 0!==t)for(var n in t)i[n]=t[n];this.showWindow(),this.action("add",i,function(t){e.setWindowContent(t.window)},function(){e.closeWindow()})},actionDelete:function(t){var e=this,i=this.getFilters();i.ids=t,this.action("delete",i,function(t){if(t.error)return void alert(t.error);var n=parseInt(i.page);if(n>1&&$(t.table).hasClass("no-data"))return void e.actionPage(n-1);e.setTableContent(t.table),e.setPagesContent(t.pagination)})},actionEdit:function(t){var e=this,i=this.getFilters();this.showWindow(),i.editId=t,this.action("edit",i,function(t){e.setWindowContent(t.window)},function(){e.closeWindow()})},actionReloadWindow:function(){var t=this.getFormEditId();t?this.actionEdit(t):this.actionAdd()},actionPage:function(t){var e=this,i=this.getFilters();i.page=t,this.action("page",i,function(t){e.setTableContent(t.table),e.setPagesContent(t.pagination)})},actionSave:function(t){var e=this,i=this.getWindow(),n=this.getFormGroups().serializeObject();this.getFormEditId()&&(n.editId=this.getFormEditId()),$.extend(n,this.getFilters()),this.action("save",n,function(n,a,s){200==s.status&&(e.setTableContent(n.table,n.editedId),e.setPagesContent(n.pagination)),t&&200==s.status?e.closeWindow():(e.setWindowContent(n.window),i.find(".alert").hide().fadeIn())})},actionSort:function(t,e){var i=this,n=this.getFilters();n.sortColumn=t,n.sortDirection=e,n.page=1,this.action("sort",n,function(t){i.setTableContent(t.table),i.setPagesContent(t.pagination)})},addActionParameters:function(t){t.renderableInstance=this.renderableInstance,t.renderableClass=this.renderableClass,null!=this.parentEditId&&(t.parentEditId=this.parentEditId);var e=this.getWindow().find(".tabs .tab.active").attr("data-tab");return void 0!==e&&(t.currentTab=e),t},attemptToCloseWindow:function(){null!=this.currentFormInput&&(this.currentFormInput==this.getFormSerialized()||confirm(KikCMS.tl("dataTable.closeWarning")))&&this.closeWindow()},closeWindow:function(){var t=this.getWindow(),e=parseInt(t.attr("data-level"));0==e?($("body").removeClass("datatableBlur"),$("body #overlay").css("z-index",3)):($(".dataTableWindow.level"+(e-1)).removeClass("blur"),$("body #overlay").css("z-index",e+2)),$(".dataTableWindow.level"+(e+1)).remove(),t.fadeOut(),t.find(".windowContent").html(""),$(".datatableThumbHoverContainer").remove(),"undefined"!=typeof tinymce&&tinymce.remove(this.getWysiwygSelector()),this.currentFormInput=null},onRowClick:function(t){t.toggleClass("selected"),this.updateToolbar()},onRowDblClick:function(t){var e=t.find("input[name=id]").val();this.actionEdit(e)},showWindow:function(){var t=this.getWindow(),e=parseInt(t.attr("data-level"));0==e?$("body").addClass("datatableBlur"):($(".dataTableWindow.level"+(e-1)).addClass("blur"),$("body #overlay").css("z-index",e+3)),t.fadeIn()},setPagesContent:function(t){this.getDataTable().find(".pages").html(t),this.initPagination()},setTableContent:function(t,e){var i=this.getDataTable().find(".table");if(i.html(t),this.initTable(),e){var n=i.find("tr[data-id="+e+"]");n.addClass("edited"),setTimeout(function(){n.addClass("easeOutBgColor"),n.removeClass("edited"),setTimeout(function(){n.removeClass("easeOutBgColor")},500)},5e3)}},setWindowContent:function(t){this.getWindow().find(".windowContent").html(t),this.initWindow()},getCurrentPage:function(){var t=this.getDataTable().find(".pagination .active a").attr("data-page");return t||1},getDataTable:function(){return $("#"+this.renderableInstance)},getFilters:function(){var t={};t.page=this.getCurrentPage(),t.search=this.getSearchField().val(),this.getDataTable().find('table thead td[data-sort="asc"]').each(function(){t.sortDirection="asc",t.sortColumn=$(this).attr("data-column")}),this.getDataTable().find('table thead td[data-sort="desc"]').each(function(){t.sortDirection="desc",t.sortColumn=$(this).attr("data-column")});var e=this.getLanguageCode(),i=this.getWindowLanguageCode();return e&&(t.languageCode=e),i&&(t.windowLanguageCode=i),t.customFilterValues=this.getFilterForm().find(":input").serializeObject(),t},getFilterForm:function(){return this.getDataTable().find(" > .filters")},getForm:function(){return this.getWindow().find("form")},getFormEditId:function(){return this.getWindow().find(".webForm").attr("data-id")},getLanguageCode:function(){return this.getDataTable().find(".toolbar .language select").val()},getNotFadingContainer:function(){var t=$("body > #notFading");return t.length||(t=$('<div id="notFading"></div>'),$("body").append(t)),t},getWindowLanguageCode:function(){return this.getWindow().find(".header select[name=language]").val()},getSearchField:function(){return this.getDataTable().find(".toolbar .search input")},getSelectedIds:function(){var t=[];return this.getDataTable().find("tr.selected .edit input[name=id]").each(function(){t.push($(this).val())}),t},getWindow:function(){var t=this.renderableInstance+"Window",e=this.getNotFadingContainer(),i=this.getDataTable().parentsUntil(".dataTableWindow").parent().attr("data-level"),n=0;i&&(n=parseInt(i)+1,t+="Level"+n);var a=e.find(" > #"+t);return a.length?e.find(" > #"+t).find(".closeButton").unbind("click"):(a='<div class="dataTableWindow level'+n+'" data-level="'+n+'" id="'+t+'"><div class="closeButton"></div><div class="windowContent"></div></div>',e.prepend(a)),e.find(" > #"+t).find(".closeButton").click(this.attemptToCloseWindow.bind(this)),$("#"+t)},getWysiwygSelector:function(){return"#"+this.getWindow().find(".webForm").attr("id")+" textarea.wysiwyg"},onChange:function(t,e){var i,n,a=this;t.focus(function(){i=t.val(),n=a.getFormSerialized()}).change(function(){if(a.currentFormInput!=n&&!confirm(KikCMS.tl("dataTable.switchWarning")))return void t.val(i);e()})},updateToolbar:function(){var t=this.getDataTable().find("tr.selected"),e=this.getDataTable().find(".toolbar .btn.delete");t.length>0?e.fadeIn():e.fadeOut()}}),SortControl=Class.extend({dragHoverClass:"dragHover",isDragging:!1,hoveringNode:!1,draggedObject:null,timeDragStarted:0,startX:0,startY:0,moveOnlyVertical:!0,selectedObjectX:0,selectedObjectY:0,$dataTable:null,onDrop:null,init:function(){var t=this,e=$(window),i=this.getHoverObjects(),n=this.getDraggables();n.on("selectstart",function(t){t.preventDefault()}),n.mousedown(function(i){1===i.which&&(t.draggedObject=$(this),t.selectedObjectX=t.getObjectToBeDragged().offset().left,t.selectedObjectY=t.getObjectToBeDragged().offset().top,t.startX=i.clientX+e.scrollLeft(),t.startY=i.clientY+e.scrollTop())}),i.hover(function(){t.isDragging&&$(this).addClass(t.dragHoverClass)},function(){t.isDragging&&($(this).removeClass(t.dragHoverClass),$(this).removeAttr("data-drop"))}),i.mousemove(function(i){if(t.isDragging){var n=$(this);if(!t.isValidDropPosition(n,i.clientY))return void n.removeAttr("data-drop");n.attr("data-drop",t.getHoverPosition(i.clientY+e.scrollTop(),n))}}),e.mousemove(this.windowMouseMove.bind(this)),e.mouseup(this.endDrag.bind(this))},cloneSelectedObject:function(){var t=this.draggedObject.parent(),e=$("<table class='draggedObject rowClone'></table>").append(t.clone());return e.css("width",t.innerWidth()),t.find("td").each(function(t){e.find("td").eq(t).css("width",$(this).innerWidth())}),e},endDrag:function(){if(this.draggedObject){var t=this.getSelectedRow();this.isDragging&&(t.attr("data-prevent-click",1),setTimeout(function(){t.removeAttr("data-prevent-click")}));var e=this.getHoverObjects();this.isDragging=!1,this.getDragObject().remove();var i=this.$dataTable.find("."+this.dragHoverClass),n=(new Date).getTime()-this.timeDragStarted>250;if(i.length&&this.onDrop&&n){var a=i.attr("data-id"),s=i.attr("data-drop"),o=t.attr("data-id");s&&this.onDrop(o,a,s)}t.removeClass("dragged"),this.draggedObject=null,e.find(".name").removeClass(this.dragHoverClass),e.removeClass(this.dragHoverClass),$("body").removeClass("noSelect").removeClass("isDragging")}},getDragObject:function(){var t=$(".draggedObject");return t.length?t:(t=this.cloneSelectedObject(),t.addClass("draggedObject"),$("body").append(t),t)},getHoverPosition:function(t,e){var i=e.outerHeight();return t>e.offset().top+i/2?"after":"before"},getObjectToBeDragged:function(){return this.getSelectedRow()},getSelectedRow:function(){return this.draggedObject.parent()},getDraggables:function(){return this.$dataTable.find("tbody tr td.sort")},getHoverObjects:function(){return this.$dataTable.find("tbody tr")},isDraggingAndNotCurrent:function(t){return!!this.isDragging&&!t.hasClass("dragged")},isValidDropPosition:function(t,e){var i=this.getHoverPosition(e,t);return("after"!=i||t.next()[0]!=this.getSelectedRow()[0])&&(("before"!=i||t.prev()[0]!=this.getSelectedRow()[0])&&t[0]!=this.getSelectedRow()[0])},windowMouseMove:function(t){var e=$(window),i=t.clientX+e.scrollLeft(),n=t.clientY+e.scrollTop();if(this.isDragging){var a=this.getDragObject(),s=this.moveOnlyVertical?this.selectedObjectX:i-(this.startX-this.selectedObjectX);a.css("left",s),a.css("top",n-(this.startY-this.selectedObjectY))}else if(this.draggedObject){var o=i>this.startX+5||i<this.startX-5,r=n>this.startY+5||n<this.startY-5;(o||r)&&(this.isDragging=!0,this.timeDragStarted=(new Date).getTime(),this.getSelectedRow().addClass("dragged"),$("body").addClass("noSelect").addClass("isDragging"))}}}),TreeSortControl=SortControl.extend({moveOnlyVertical:!1,hoveringNode:!1,init:function(){this.$.init.call(this);var t=this;this.getDraggables().hover(function(){t.hoveringNode=!0},function(){t.hoveringNode=!1})},cloneSelectedObject:function(){return this.draggedObject.clone()},getDraggables:function(){return this.getHoverObjects().find(".name")},getObjectToBeDragged:function(){return this.draggedObject},getHoverObjects:function(){return this.$dataTable.find(".pageObject")},getHoverPosition:function(t,e){return this.hoveringNode&&this.mayDropInto(e)?"into":this.$.getHoverPosition.call(this,t,e)},getParentRow:function(){var t=this.getSelectedRow(),e=t.attr("data-level");return t.prevAll(".level"+(e-1)+":first")},getSelectedRow:function(){return this.draggedObject.parent().parent()},isValidDropPosition:function(t,e){return!t.hasClass("dragged")&&e},mayDropInto:function(t){var e=parseInt(t.attr("data-level")),i=this.getParentRow();if(i&&i.attr("data-id")==t.attr("data-id"))return!1;if(t.hasClass("detached"))return!1;if(e>0){if(e>=t.prevAll(".level0:first").attr("data-max-level"))return!1}return!0}}),Finder=Class.extend({renderableInstance:null,renderableClass:null,shiftKeyPressed:!1,pickingMode:!1,cutFileIds:[],action:function(t,e,i){void 0===e.folderId&&(e.folderId=this.getCurrentFolderId()),e.renderableInstance=this.renderableInstance,e.renderableClass=this.renderableClass,KikCMS.action("/cms/finder/"+t,e,i)},actionAddFolder:function(){var t=this,e=prompt(KikCMS.tl("media.createFolder"),KikCMS.tl("media.defaultFolderName"));e&&this.action("createFolder",{folderName:e},function(e){t.setFilesContainer(e.files,e.fileIds)})},actionCut:function(){this.cutFileIds=this.getSelectedFileIds(),this.initCutFiles()},actionDelete:function(){var t=this,e=this.getSelectedFileIds(),i=e.length>1?KikCMS.tl("media.deleteConfirm",{amount:e.length}):KikCMS.tl("media.deleteConfirmOne");confirm(i)&&this.action("delete",{fileIds:e},function(e){if(e.errorMessage)return void alert(e.errorMessage);t.setFilesContainer(e.files)})},actionEditFileName:function(t){var e=this,i=t.attr("data-id"),n=KikCMS.removeExtension(t.find(".name span").text()),a=prompt(KikCMS.tl("media.editFileName"),n);a&&this.action("editFileName",{fileId:i,fileName:a},function(t){e.setFilesContainer(t.files,t.fileIds)})},actionPaste:function(){var t=this;this.action("paste",{fileIds:this.cutFileIds},function(e){t.cutFileIds=[],t.setFilesContainer(e.files,e.fileIds)})},actionOpenFolder:function(t){var e=this;this.saveCurrentFolderId(t),this.action("openFolder",{folderId:t},function(t){e.setFilesContainer(t.files),e.setPath(t.path)})},fileDeSelect:function(t){t.removeClass("selected"),t.trigger("selectionChange"),this.updateToolbar()},fileSelect:function(t){t.addClass("selected"),t.trigger("selectionChange"),this.updateToolbar()},init:function(){this.initUpload(),this.initFiles(),this.initKeyEvents(),this.initButtons(),this.initSearch(),this.initPath()},initButtons:function(){this.getToolbar().find(".delete").click(this.actionDelete.bind(this)),this.getToolbar().find(".addFolder").click(this.actionAddFolder.bind(this)),this.getToolbar().find(".cut").click(this.actionCut.bind(this)),this.getToolbar().find(".paste").click(this.actionPaste.bind(this))},initCutFiles:function(){var t=this;t.getFileContainer().find(".file").removeClass("cut"),$.each(this.cutFileIds,function(e,i){t.getFileContainer().find(".file-"+i).addClass("cut")}),this.updateToolbar()},initFiles:function(){var t=this,e=this.getFileContainer(),i=e.find(".file");i.each(function(){var i=$(this),n=i.find("img, .glyphicon, .extension, .name span");i.find(".thumb").click(function(e){$(this).parent().hasClass("selected")&&(e.stopPropagation(),t.shiftKeyPressed&&t.fileDeSelect(i))}),i.find(".name span").click(function(){i.hasClass("selected")&&setTimeout(function(){i.attr("data-double-clicked")||t.actionEditFileName(i)},500)}),i.find("img").on("dragstart",function(t){t.preventDefault()}),n.click(function(n){t.shiftKeyPressed&&!t.pickingMode||e.find(".file.selected").removeClass("selected"),i.hasClass("selected")&&t.shiftKeyPressed?t.fileDeSelect(i):t.fileSelect(i),n.stopPropagation()}),n.on("dblclick",function(e){if(i.attr("data-double-clicked",!0),setTimeout(function(){i.removeAttr("data-double-clicked")},500),i.hasClass("folder"))return t.actionOpenFolder(i.attr("data-id")),void e.stopPropagation();t.pickFile(i),e.stopPropagation()})}),i.on("dblclick",function(){var e=$(this);if(e.hasClass("folder"))return void t.actionOpenFolder(e.attr("data-id"));e.hasClass("selected")&&t.pickFile(e)}),this.getFileContainer().click(function(){t.shiftKeyPressed||e.find(".file.selected").each(function(){t.fileDeSelect($(this))})}),this.updateToolbar(),this.initCutFiles()},initKeyEvents:function(){var t=this;$(document).keydown(function(e){e.keyCode==keyCode.SHIFT&&(t.shiftKeyPressed=!0)}),$(document).keyup(function(e){e.keyCode==keyCode.SHIFT&&(t.shiftKeyPressed=!1)})},initPath:function(){var t=this;this.getFinder().find(".path ul li a").click(function(){var e=$(this).attr("data-id");t.actionOpenFolder(e)})},initSearch:function(){var t=this;this.getSearchField().searchAble(function(e){t.action("search",{search:e},function(i){t.setFilesContainer(i.files),t.setPath(i.path),t.getFileContainer().find(".file .name span").highlight(e)})})},initUpload:function(){var t=this;new FinderFileUploader({$container:this.getFinder(),onSuccess:function(e){t.setFilesContainer(e.files,e.fileIds)},addParametersBeforeUpload:function(e){return e.append("folderId",t.getCurrentFolderId()),e.append("renderableInstance",t.renderableInstance),e.append("renderableClass",t.renderableClass),e}}).init()},getFinder:function(){return $("#"+this.renderableInstance)},getFileContainer:function(){return this.getFinder().find(".files .files-container")},pickFile:function(t){this.pickingMode?t.trigger("pick"):window.open(t.attr("data-url"))},setFilesContainer:function(t,e){var i=this.getFileContainer();i.html(t),this.initFiles(),$.each(e,function(t,e){if(!1!==e){var n=i.find(".file-"+e);n.addClass("edited"),setTimeout(function(){n.find(".thumb").addClass("easeOutBgColor"),n.removeClass("edited"),setTimeout(function(){n.find(".thumb").removeClass("easeOutBgColor")},500)},5e3)}})},setPath:function(t){this.getFinder().find(".path").html(t),this.initPath()},getSearchField:function(){return this.getToolbar().find(".search input")},getSelectedFileIds:function(){var t=[];return this.getFileContainer().find(".file.selected").each(function(){t.push($(this).attr("data-id"))}),t},getToolbar:function(){return this.getFinder().find(".toolbar")},getCurrentFolderId:function(){return this.getFinder().find("input.currentFolderId").val()},saveCurrentFolderId:function(t){this.getFinder().find("input.currentFolderId").val(t)},selectedSingleFolder:function(){var t=this.getFileContainer().find(".file.selected");return!(t.length>1)&&t.hasClass("folder")},updateToolbar:function(){var t=this,e=this.getToolbar();this.getSelectedFileIds().length>=1?this.selectedSingleFolder()?setTimeout(function(){t.getSelectedFileIds().length>=1&&e.find(".delete, .cut").fadeIn()},500):e.find(".delete, .cut").fadeIn():e.find(".delete, .cut").fadeOut(),this.cutFileIds.length>0?e.find(".paste").fadeIn():e.find(".paste").fadeOut()}}),FinderFileUploader=function(t){this.onSuccess=t.onSuccess,this.$container=t.$container,this.action=t.action?t.action:"/cms/finder/upload",this.fileTypes=t.fileTypes?t.fileTypes:[],t.addParametersBeforeUpload?this.addParametersBeforeUpload=t.addParametersBeforeUpload:this.addParametersBeforeUpload=function(t){return t}};FinderFileUploader.prototype={init:function(){var t=this,e=this.$container.find(".btn.upload");e.find("input").on("click",function(t){e.hasClass("disabled")&&t.preventDefault()}),e.find("input").on("change",function(){var e=new FormData,i=this.files.length,n=0;if(i>KikCMS.maxFileAmount)return void alert(KikCMS.tl("media.uploadMaxFilesWarning",{amount:KikCMS.maxFileAmount}));for(var a=0;a<i;a++){var s=this.files[a];s.size>KikCMS.maxFileSize?alert(KikCMS.tl("media.uploadMaxFileSizeWarning",{max:KikCMS.maxFileSizeString})):(e.append("files[]",s),n++)}t.checkFileTypes(this.files)&&n&&t.actionUpload(e)})},actionUpload:function(t){var e=this,i=this.$container.find(".btn.upload"),n=this.$container.find(".progress-bar");i.addClass("disabled"),n.parent().fadeIn(),t=this.addParametersBeforeUpload(t),KikCMS.action(this.action,t,function(t){e.onSuccess(t),t.errors&&t.errors.length>0&&alert(t.errors.join("\n")),i.removeClass("disabled"),i.find("input").val(""),n.parent().fadeOut()},function(){i.removeClass("disabled"),i.find("input").val(""),n.parent().fadeOut()},function(){var t=$.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",function(t){var e=t.position/t.totalSize*100;n.width(e+"%"),n.attr("aria-valuenow",e)},!1),t})},checkFileTypes:function(t){for(var e=0;e<t.length;e++)for(var i=t[e].name,n=0;n<this.fileTypes.length;n++){var a=this.fileTypes[e];if(i.substr(i.length-a.length,a.length).toLowerCase()!=a.toLowerCase())return void alert(KikCMS.tl("media.fileTypeWarning")+this.fileTypes.join(", "))}return!0}};var WebForm=Class.extend({renderableInstance:null,renderableClass:null,parent:null,actionGetFinder:function(t){var e=this,i=t.find(".file-picker"),n=t.find(".btn.upload"),a=i.find(".pick-file");KikCMS.action("/cms/webform/getFinder",{},function(s){i.find(".finder-container").html(s.finder),i.slideDown(),i.on("pick",".file",function(){var s=$(this),o=s.attr("data-id");e.actionPickFile(t,o),i.slideUp(function(){s.removeClass("selected"),a.addClass("disabled")}),n.removeClass("disabled")}),i.on("selectionChange",".file",function(){i.find(".file.selected:not(.folder)").length>=1?a.removeClass("disabled"):a.addClass("disabled")}),a.click(function(){if(!a.hasClass("disabled")){var s=i.find(".file.selected"),o=s.attr("data-id");e.actionPickFile(t,o),i.slideUp(function(){s.removeClass("selected"),a.addClass("disabled")}),n.removeClass("disabled")}}),n.addClass("disabled")})},actionPreview:function(t,e,i){var n=t.find(".preview"),a=t.find(".preview .thumb"),s=t.find(".buttons .pick"),o=t.find(".buttons .delete");i.dimensions?(a.css("width",i.dimensions[0]/2),a.css("height",i.dimensions[1]/2)):(a.css("width","auto"),a.css("height","auto")),n.removeClass("hidden"),a.html(i.preview),t.find(" > input[type=hidden].fileId").val(e),s.addClass("hidden"),o.removeClass("hidden")},actionPickFile:function(t,e){var i=this;KikCMS.action("/cms/webform/getFilePreview",{fileId:e},function(n){i.actionPreview(t,e,n)})},getWebForm:function(){return $("#"+this.renderableInstance)},init:function(){this.initAutocompleteFields(),this.initDateFields(),this.initFileFields(),this.initWysiwyg(),this.initPopovers()},initAutocompleteFields:function(){var t=this;this.getWebForm().find(".autocomplete").each(function(){var e=$(this),i=e.attr("data-field-key"),n=e.attr("data-route");KikCMS.action(n,{field:i,renderableInstance:t.renderableInstance,renderableClass:t.renderableClass},function(t){e.typeahead({items:10,source:t})})})},initDateFields:function(){this.getWebForm().find(".type-date input").each(function(){var t=$(this);t.datetimepicker({format:t.attr("data-format"),locale:moment.locale()})})},initFileFields:function(){var t=this;this.getWebForm().find(".type-file").each(function(){var e=$(this),i=e.find(".file-picker"),n=e.find(".btn.upload"),a=e.find(".btn.delete"),s=e.find(".btn.pick"),o=e.find(".btn.preview"),r=e.find(".btn.pick, .btn.preview");t.initUploader(e),i.find(".buttons .cancel").click(function(){i.slideUp(),n.removeClass("disabled")}),a.click(function(){e.find(" > input[type=hidden].fileId").val(""),s.removeClass("hidden"),a.addClass("hidden"),o.find("img").remove(),o.addClass("hidden")}),r.click(function(){if(0!=$(this).attr("data-finder"))return i.find(".finder").length>=1?(i.slideToggle(),void n.toggleClass("disabled")):void t.actionGetFinder(e)})})},initPopovers:function(){this.getWebForm().find('[data-toggle="popover"]').each(function(){var t=$(this).attr("data-content");$(this).popover({placement:"auto bottom",html:!0,content:t,container:"body"})})},initTinyMCE:function(){var t=this;tinymce.init({selector:this.getWysiwygSelector(),setup:function(t){t.on("change",function(){tinymce.triggerSave()})},language_url:"/cmsassets/js/tinymce/"+KikCMS.tl("system.langCode")+".js",language:KikCMS.tl("system.langCode"),theme:"modern",relative_urls:!1,remove_script_host:!0,document_base_url:KikCMS.baseUri,plugins:["advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace visualblocks","visualchars code insertdatetime media nonbreaking save table contextmenu directionality template paste","textcolor colorpicker textpattern codesample toc"],
toolbar1:"undo redo | insert | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | forecolor backcolor | codesample",image_advtab:!0,content_css:["/cmsassets/css/tinymce/content.css"],link_list:this.getLinkListUrl(),ui_container:"#"+this.renderableInstance,file_picker_callback:function(e){t.getFilePicker(e)}})},initUploader:function(t){var e=this;new FinderFileUploader({$container:t,action:"/cms/webform/uploadAndPreview",addParametersBeforeUpload:function(i){return i.append("folderId",t.find(".btn.upload").attr("data-folder-id")),i.append("renderableInstance",e.renderableInstance),i.append("renderableClass",e.renderableClass),i},onSuccess:function(i){i.fileId&&e.actionPreview(t,i.fileId,i)}}).init()},initWysiwyg:function(){var t=this;0!=$(this.getWysiwygSelector()).length&&("undefined"==typeof tinymce?$.getScript("//cdn.tinymce.com/4/tinymce.min.js",function(){window.tinymce.dom.Event.domLoaded=!0,tinymce.baseURL="//cdn.tinymce.com/4",tinymce.suffix=".min",t.initTinyMCE()}):this.initTinyMCE())},getFilePicker:function(t){var e=function(e){var n=e.attr("data-id");t("/finder/file/"+n,{text:e.find(".name span").text()}),i.close()},i=tinymce.activeEditor.windowManager.open({title:"Image Picker",url:"/cms/filePicker",width:952,height:768,buttons:[{text:"Insert",onclick:function(){var t=$(i.$el).find("iframe")[0].contentWindow.$(".filePicker"),n=t.find(".file.selected");if(!n.length)return!1;e(n)}},{text:"Close",onclick:"close"}]});i.on("open",function(){$(i.$el).find("iframe").on("load",function(){this.contentWindow.$(".filePicker").on("pick",".file",function(){e($(this))})})})},getLinkListUrl:function(){return this.parent&&this.parent.getWindowLanguageCode()?"/cms/getTinyMceLinks/"+this.parent.getWindowLanguageCode()+"/":"/cms/getTinyMceLinks/"},getWysiwygSelector:function(){return"#"+this.getWebForm().attr("id")+" textarea.wysiwyg"},removeExtension:function(t){return t.replace(/\.[^\/.]+$/,"")},tl:function(t,e){var i=this.translations[t];return $.each(e,function(t,e){i=i.replace(new RegExp(":"+t,"g"),e)}),i}}),PagesDataTable=DataTable.extend({actionPath:"/cms/datatable/pages/",init:function(){this.$.init.call(this),this.initPageTypeMenu()},initWindow:function(){this.$.initWindow.call(this),this.onChange(this.getTemplateField(),this.actionReloadWindow.bind(this))},initPageTypeMenu:function(){var t=this;this.getDataTable().find(".pageTypes ul li a").click(function(){t.actionAdd({pageType:$(this).attr("data-type")})})},initTable:function(){this.$.initTable.call(this),this.initTreeSortControl(),$(".action.preview").click(function(){var t=$(this).parent().attr("data-plid");window.open("/cms/preview/"+t)})},initTreeSortControl:function(){var t=new TreeSortControl;t.$dataTable=this.getDataTable(),t.onDrop=this.onPageDrop.bind(this),t.init()},actionSave:function(t){var e=this.getForm().find("input[name=name]").val();"link"!=this.getForm().find("input[name=type]").val()&&this.getForm().find("input[name=url]").each(function(){$(this).val()||$(this).val(KikCMS.toSlug(e))}),this.$.actionSave.call(this,t)},getFilters:function(){var t=this.$.getFilters.call(this);return this.getTemplateField().each(function(){t.template=$(this).val()}),this.getWindow().find("input[name=type]").each(function(){t.pageType=$(this).val()}),t},onPageDrop:function(t,e,i){var n=this,a=this.getFilters();a.pageId=t,a.targetPageId=e,a.position=i,a=this.addActionParameters(a),KikCMS.action("/cms/datatable/pages/tree-order",a,function(t){n.setTableContent(t.table)})},getTemplateField:function(){return this.getWindow().find("#template")}}),SelectDataTable=DataTable.extend({getFilters:function(){var t=this.$.getFilters.call(this);return t.selectedValues=this.getSelectionFromInput(),t},getInputField:function(){return this.getDataTable().next()},getSelectionFromInput:function(){var t=[];return this.getInputField().val()&&(t=JSON.parse(this.getInputField().val())),t},initTable:function(){this.$.initTable.call(this),this.selectCheckBoxes(),this.initCheckBoxes()},initCheckBoxes:function(){var t=this;this.getDataTable().find("td.select input").change(function(){var e=$(this),i=e.parent().parent().attr("data-id"),n=t.getSelectionFromInput();if(e.prop("checked"))n.push(i);else{var a=n.indexOf(i);a>-1&&n.splice(a,1)}t.getInputField().val(JSON.stringify(n))})},onRowClick:function(t){var e=t.find(".select input");e.prop("checked",!e.prop("checked")),e.change()},onRowDblClick:function(t){},selectCheckBoxes:function(){var t=this,e=this.getSelectionFromInput();$.each(e,function(e,i){t.getDataTable().find(".table tr[data-id="+i+"]").each(function(){$(this).find(".select input").prop("checked",!0)})})}}),TranslationsDataTable=DataTable.extend({initWindow:function(){this.$.initWindow.call(this),this.initKeyField()},initKeyField:function(){var t=this,e=this.getForm().find("select[name=key]");this.updateTranslationFields(e.val()),e.change(function(){t.updateTranslationFields($(this).val())})},updateTranslationFields:function(t){var e=this;KikCMS.action("/cms/getTranslationsForKey",{key:t},function(t){t&&$.each(t,function(t,i){e.getForm().find("textarea[data-language-code="+t+"]").val(i)})})}}),Statistics=Class.extend({ATTR_INTERVAL:"data-interval",CLASS_BTN_DEFAULT:"btn-default",CLASS_BTN_PRIMARY:"btn-primary",CLASS_FAILED:"failed",CLASS_GLOW:"glow",CLASS_LOADING:"loading",CLASS_START:"start",COLOR_PINK:"#3669c9",COLOR_BLUE:"#df137a",STR_FETCHING_NEW_DATA:KikCMS.translations["statistics.fetchingNewData"],STR_FETCHING_FAILED:KikCMS.translations["statistics.fetchingFailed"],STR_FETCH_NEW_DATA:KikCMS.translations["statistics.fetchNewData"],STR_VISITORS:KikCMS.translations["statistics.visitors"],URL_GET_VISITORS:"/cms/stats/getVisitors",URL_UPDATE_STATISTICS:"/cms/stats/update",$controls:null,$buttonRefresh:null,$buttonRefreshLbl:null,$settingsInput:null,$intervalInputs:null,$intervalButtons:null,$fieldStart:null,$fieldEnd:null,$rangeInputs:null,$visitors:null,$tableOverviewBody:null,settings:null,getInterval:function(){return this.$intervalButtons.filter("."+this.CLASS_BTN_PRIMARY).attr(this.ATTR_INTERVAL)},init:function(){"undefined"!=typeof google&&$("#visitors").length&&(google.charts.load("current",{packages:["corechart"]}),google.charts.setOnLoadCallback(this.renderChart.bind(this)),this.initElements(),this.settings=JSON.parse(this.$settingsInput.val()),this.$rangeInputs.each(this.initRangeInput.bind(this)),this.$intervalButtons.click(this.onIntervalButtonClick.bind(this)),this.$buttonRefresh.click(this.onRefreshClick.bind(this)))},initElements:function(){this.$visitors=$("#visitors"),this.$controls=$(".controls"),this.$settingsInput=this.$controls.find("input[name=settings]"),this.$buttonRefresh=this.$controls.find(".refresh"),this.$rangeInputs=this.$controls.find(".dateRange input[type=date]"),this.$intervalButtons=this.$controls.find(".interval button"),this.$fieldStart=this.$controls.find(".start"),this.$fieldEnd=this.$controls.find(".end"),this.$tableOverviewBody=$("#tab-overview").find("table tbody"),this.$buttonRefreshLbl=this.$buttonRefresh.find(".lbl")},initRangeInput:function(t,e){var i=$(e),n={format:this.settings.dateFormat,minDate:this.settings.minDate,maxDate:this.settings.maxDate,useCurrent:!1};i.hasClass(this.CLASS_START)&&(n.defaultDate=this.settings.startDate),i.datetimepicker(n),i.on("dp.change",this.renderChart.bind(this))},onButtonRefreshFadeOut:function(){this.$buttonRefresh.addClass(this.CLASS_LOADING),this.$buttonRefresh.addClass(this.CLASS_BTN_DEFAULT),this.$buttonRefresh.removeClass(this.CLASS_BTN_PRIMARY),this.$buttonRefresh.removeClass(this.CLASS_GLOW),this.$buttonRefreshLbl.text(this.STR_FETCHING_NEW_DATA)},onDataUpdate:function(t){if(!t.success)return this.$buttonRefresh.removeClass(this.CLASS_LOADING),void this.$buttonRefreshLbl.text(this.STR_FETCHING_FAILED);this.$buttonRefresh.removeClass(this.CLASS_LOADING),this.$buttonRefresh.removeClass(this.CLASS_BTN_DEFAULT),this.$buttonRefresh.addClass(this.CLASS_BTN_PRIMARY),this.$buttonRefresh.addClass(this.CLASS_GLOW),this.$buttonRefreshLbl.text(this.STR_FETCH_NEW_DATA),this.$rangeInputs.each(function(){$(this).data("DateTimePicker").maxDate(moment(t.maxDate))})},onIntervalButtonClick:function(t){var e=$(t.target);this.$intervalButtons.removeClass(this.CLASS_BTN_PRIMARY),this.$intervalButtons.addClass(this.CLASS_BTN_DEFAULT),e.addClass(this.CLASS_BTN_PRIMARY),e.removeClass(this.CLASS_BTN_DEFAULT),this.renderChart()},onRefreshClick:function(){return!this.$buttonRefresh.hasClass(this.CLASS_LOADING)&&(this.$buttonRefresh.hasClass(this.CLASS_FAILED)?(this.updateAnalyticsData(),!1):(this.renderChart(),void this.$buttonRefresh.fadeOut(this.onButtonRefreshFadeOut.bind(this))))},populateOverviewTable:function(t){var e="";$.each(t,function(t,i){e+="<tr><td>"+t+":</td><td>"+i+"</td></tr>"}),this.$tableOverviewBody.html(e)},populateVisitorDataTable:function(t,e){var i="";$.each(e,function(t,e){i+="<tr><td><span>"+e.value+"</span></td><td>"+e.visits+'</td><td><span class="percentage" style="width: '+5*e.percentage+'px;"></span>'+e.percentage+"%</td></tr>"}),$("#tab-"+t).find("table tbody").html(i)},renderChart:function(){var t={interval:this.getInterval(),start:this.$fieldStart.val(),end:this.$fieldEnd.val()};KikCMS.action(this.URL_GET_VISITORS,t,this.renderChartWithData.bind(this))},renderChartWithData:function(t){var e={title:this.STR_VISITORS,legend:{position:"bottom"},colors:[this.COLOR_PINK,this.COLOR_BLUE],chartArea:{width:"80%"}},i=new google.visualization.DataTable(t.visitorsData),n=new google.visualization.AreaChart(this.$visitors[0]);this.populateOverviewTable(t.overviewData),$.each(t.visitorData,this.populateVisitorDataTable.bind(this)),n.draw(i,e),t.requiresUpdate?this.updateAnalyticsData():this.$buttonRefresh.fadeOut()},updateAnalyticsData:function(){this.$buttonRefresh.fadeIn(),$.ajax({url:this.URL_UPDATE_STATISTICS,success:this.onDataUpdate.bind(this),dataType:"json"})}}),statistics=new Statistics;$(function(){statistics.init()}),$(function(){$(".action.link").click(function(){var t=$(this).prev().prev().prev().text().trim(),e=window.location.protocol+"//"+window.location.hostname;alert(e+"/cms/login/reset?email="+t)})});